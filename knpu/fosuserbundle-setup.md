# FOSUserBundle Setup

The most popular bundle in the entire symphony world is by far FOSUserBundle. It's easy to know why. It gives you a lot of functionality, but there's also a lot of confusion about what it gives you. A lot of times I get questions where people aren't really sure what FOSUserBundle does and what it does and doesn't have to do with security. I also get questions about how FOSUserBundle works with Guard Authentication. We're going to talk about all of this. We're going to install FOSUserBundle, we're going to customize the heck out of it, and we're going to make it work really well in your project.

Now as always, you should totally code along with me. You can download the course code from this page. When you unzip it in the start directory you'll have the same code that you see here. Just open up the Read Me file and follow down to figure out how to set up the project. The last step will be to go to your terminal and run php bin/console server:run. To get our built-in php web server going. Then you can go to localhost:8000, and welcome to AquaNote. This is the project that we've been building in our main Symphony tutorial, and it already has a bunch of features, but it does not have any login. This login link up here goes nowhere. It has no security at all. Let's add some.

Find the FOSUserBundle documentation. You can Google for it, it lives on symphony.com. We're just going to go down the install instructions, but in a little bit of a different order. I'm going to copy the composer require line, but don't worry about the version number. It will grab the latest version automatically. I'll go over to my terminal, open a new tab, and then run composer require friendsofsymfony/user-bundle. While I'm waiting for that, we also know that we're definitely going to need to enable the bundle so I'll copy that line for app kernel. Go into app/appkernel, and we will enable that bundle.

The FOSUserBundle also has a dependency on the swift mailer bundle, which we removed earlier in the tutorial just to show that we could. So I'm going to uncomment that out to re-add the swift mailer bundle. Technically you can use the FOSUserBundle without it, but most of the time you will want FOSUserBundle to send emails for you.

Now if you flip back to your terminal you probably are going to see a huge error. You can see up here it did end up installing FOSUserBundle just fine, but then when it was clearing our cache we got an error that says the db_driver at path fos_user must be configured.

This bundle has some required configurations so as soon as you enable the bundle here, if you don't have that configuration you're gonna get an error. So, that's what we need to fill in.

Now what does fos bundle actually give us though? In reality, fos bundle only gives you two things. A user class that you can store in a database, and a bunch of routes and controllers for common things like registration, edit password, reset password, and a login page. It doesn't actually have anything to do with security. It has very little to do with security. Now in order to use the user class that they provided, we need to create a small user class in our project that extends theirs.

So inside of my src, app bundle, entity directory, I'm going to create a new php class called user. And then I'm going to need to extend their base user so I'm going to say use user and you'll see one in here for fosuserbundle\model I'll say as baseuser I'll alias it so we can say extends baseuser. The only thing we need to add to this class is protected id property. It has to be protected because it exists in the base class as protected.

Now this is just normal user entity so I'm going to go to code generate or command n and I'm going to go ORM class to generate my ORM class at the top. I'm actually going to put ticks around the user here because that's a protected word in some database engines so that will allow us to use that as the table name. Then we go back down here again, go back to code generate or command and type ORM annotation and I'll add the annotation for my id column. My primary key. Finally, I'll go back to code generate one last time so we can generate the id getter. The docs do have an example user class that you can copy from but I find this just as easy.

Now that we have the user class we can go and add the required configuration. If you scroll down a little bit ... and we're going to do things a little bit out of order ... you'll see configure the FOSUserBundle. Copy the configuration here, this is all required, and flip back, open your app config, config.yml, and put that anywhere. I'll put that on the bottom. The ORM is the driver we're using, firewall name is actually the name of your firewall and security.yml so it's main by default. Then the user class is AppBundle\Entity\User and then for some email things below I'm just going to fill in hello@aquanote.com and sender name let's say AquaNote Postman. I'll talk a little bit more later about the emails that FOSUserBundle sends.

Now finally, with that configuration, our application is at least not broken anymore. You can run bin console and it won't blow up. Which means we need to generate our migration for our user class. So I'm going to do .bin/console doctrine:migrations:diff, it dumps out the generated migration, that looks correct, it's building the user class, and then I'll run back to migrations:migrate to execute that. Perfect.

So at this point the only thing that this bundle has given us is this base user class, which has a bunch of properties on it like user name, email, password, last login, etc. remember the second thing that this bundle gives you is a bunch of routes and controllers for registration and other things. To get those we need to import the routes. So go back to the documentation, scroll down a little bit, you'll see a step six import the routing dot ... routing files. I'll copy those two lines, then go into my app config routing.yml, and it doesn't matter but we'll put those on top. As soon as you do that, if you move over to your terminal, you can run ./bin/console debug:router and check this out. We have a bunch of new routes. /login, /profile/edit, /register, things for resetting your password. Changing your password. So yes quite literally after we run that line we can go to /register and see a registration page. I know it looks terrible, we'll fix that really soon.

I also want you to notice that if you scroll all the way down to this bottom of this page, there's a section that says advanced routing configuration. I'll open that up in a new tab because in reality if you don't need all of these features, like for example, if you want registration and reset password but you don't need the profile routes, then instead of importing this all.xml you can just import whichever ones that you want. You can even control the prefix on those urls. So if you're not using some of these routes go ahead and remove them. Only import the ones that you actually need.

Now on the registration page if yours doesn't look line mine, if you see weird translation keys, make sure you go into app config config.yml and up near the top make sure that you have the framework translator key uncommented. FOSUserBundle uses the translator to translate its keys into other languages so by doing that you'll suddenly actually see the real strings. For the most part that's it we have more work to do but notice we haven't touched security at all, and yet we already have a bunch of user class and a bunch of routes and controllers that we can take advantage of. In fact in order to get registration to work there's only two tiny bits of configuration that we need to put in our security.yml.

The first is called encoders. What we're gonna say AppBundle\Entity\User: bcrypt and what that's saying is when we register obviously symphony needs to encrypt the password and store the encrypted password in the database, this tells symphony what algorithm to use. So it's really not that related to security.

The other bit that we need, which is inside the documentation under step four, is this little providers key here. I'll copy that, move over and override what was there. This is a little bit more related to security, and I'll talk a little bit more about it in a moment, but for right now that's going to ... when you register with FOSUserBundle it automatically logs you in which is nice. So this little bit of configuration is needed to make that work. Notice we haven't actually touched any of the meat of our security. We have not yet touched our firewall.

All right so let's try it. I'll refresh /register, let's log in. Aquanaut1@gmail.com, aquanaut1, password turtles. Check this out, and boom! Not only did we hit this confirmation page, but we are logged in as aquanaut1. You can see that we even have a role_user. Every user gets at least that role.

So yeah, we are set up. We haven't touched security basically at all but we're already using a lot of features of this bundle. Notice we can't actually log out yet. If we click log out here, you'll actually see an error and we can't actually log in yet.

That's not the fault of FOSUserBundle, it's just that we haven't set up our security yet. FOSUserBundle is actually doing its job, we just now need to set up some security. Let's do that next.
