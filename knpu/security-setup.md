# Security Setup

FOS user bundle's now installed, and we're taking advantage of pretty much all of it's features. It's user base class, it's routes and controllers for registration and reset password. All of those things work. The only thing we can't do is log in and log out. Because those have nothing to do with FOS user bundle, they have everything to do with us configuring security in our application. And that's why when you try to log in, you get this strange error message.

Now check this out first. If you go to slash login, I want to prove to you how little FOS user bundle is doing in terms of security. You hover over your web debo tool bar, you can see that the controller class for this is security controller. So let's flip over, and I'll actually do a file by file name. Shift, shift, and I'll say, security controller to load that in the user bundle.

Check this out. Look at login action. All it does is read any possible authentication errors off the request, and render a template. It has no logic whatsoever for processing the form submit, or security, or anything like that. It simply renders a template. And check out logout action. That's actually the action that called when you go to slash logout. It does nothing, because again, none of the security logic is in the bundle itself.

All it gives you is a route so that you're able to go to slash logout, but then you need to configure your application to do something when the user goes to slash logout. So let's start there with logging out. Right now if you go to slash logout, you'll se that error message that we just saw. This is actually coming from FOS user bundle. To configure logout, super simple. On your firewall, instead of logout, colon, space, tilde. And that's it.

As soon as you do that, when you go to slash logout, Symphony is waiting for you to go to that URL and logging you out. You can see now we are anonymous. What about logging in? It's the same thing. In order to log in, you're going to use the form login. So [inaudible 00:02:38] form_login and that's all you need. Now I'm going to actually get rid of the tilde and below I'm gonna say csrf_token_generator: security.csrf.token_manager. And that's gonna add csrf protection to my login form but strictly speaking that's optional.

And as soon as we do that we can go to slash login. I'll type aquanaut1. Password: turtle. Password: turtles. And boom! We are in. So FOS user bundle just gives us a login form. That's it. Just an html template. And it's nothing to do with security. All of the security stuff is handled by us. Now you'll also notice on the login form there's a remember me check box which you don't have to use. You can remove it if you want to. But since we do have it, to make that work we just need to activate it in our firewall. So I'll say remember_me and we need to add a little cryptographic secret there. And we'll set that to the secret key that's in our parameters [inaudible 00:04:09]. Now when you click remember me it should actually use a remember me cookie.

So, yeah. In about three lines of code we have a working security system. So now let's actually hook up this login logout link here. So I'm gonna go to app resources views. Base.html.twig. Go down to login here and we're gonna put a little if statement: if is_granted('ROLE_USER'). I'm gonna add my else and my and if. One of the properties of ... FOS user bundle guarantees that no matter who you're logged in as, you'll always at least have role_user. So it's safe to use that to figure out whether or not the user is logged in.

Now, here I'll set an anchor tag. And for logout, we use fos_user_security_logout and then we'll say logout. Put this all inside of an li tag. Now why fos_user_security_logout? Because remember, that's one of the routes that we inherited. If we run debug router we can see this is the one I want. We use a similar one for login. Center the set, I'll copy that li and change it to login. And use the FOS user security login route. Simple enough.

Hit back, refresh and we got it. Logout. And we are logged out. Man, super easy! So go over to your command line. Now I actually want you to query the database to see what your user looks like. So I use bin/console/ doctrine:query:sql and say SELECT* FROM USER. So check this out. WE inherited a lot of fields from the base user which is cool. We have Usenet, we have email, we have a thing called enable. We have password. It even tracks our last login.

There are two important things I want to point out here: you notice you have username and username_canonical? And then email and email_canonical. So what's going on there? This is something you probably aren't going to care about and it's handled automatically for you. When you set the username or the email on your user, then Fos user bundle automatically also sets the corresponding canonical field. The reason this exists is that the username field and the email field will contain the username and email the way the user typed it in when they registered. So if they had a capital a on the username, then it will be capital a, aquanaut. But then the canonical fields are lowercased and normalized. And when you actually login, the query is done to the canonical field. And the reason it's done this way is some databases like PostRes are case sensitive. So by doing this you can have the username show with uppercases the way the user typed it in, but they can login using lowercase or uppercase as their username. So it might not be something you care about but it's gonna be taken care of automatically behind the scenes. So you can basically ignore those fields.

And by the way, when you're logging in you're actually logged in with the username. But if you want to, you can actually log in with the username or email address. At the bottom of the pages there's a spot about that. Says "Login by username or email." It's very simple. You just need to make this one change and [inaudible 00:08:13] that yml file. So I won't do that but if you want to do that, you can. And of course you'll need to override your template to say username or email. We'll talk about how to do that in a second.

Now back on the database dump. The one other thing I want to tell you is notice roles. Roles is actually an array field. Which means that on your user object. I'm gonna hold command click and base user. Roles holds an array. And then it serializes in the database when you get it back. So if you want to set roles on your user, you can set as many roles as you want on the user and it will automatically be serialized to the database.

Now notice even though it's empty here, when we login we get role user. So that's a little bit of a tricky thing. FOS user bundle automatically adds this always. Whether or not it actually exists in the database. Don't expect to see it in the database, but it is there.

So let's say an example of a user that has a different role. So one of the many things about the bundle is it actually comes with a bunch of in-console commands for activating users, changing passwords, creating and promoting, demoting, etc. So let's use fos:user:create. Let's create an admin account: admin@aquanote.com. Password: admin. Awesome. Suddenly, we have a user called admin. And then we'll say fos:user:promote. And we're gonna promote admin to have a role called ROLE_ADMIN. And as soon as we do this, we can run our query again. And this time we see that we have ROLE_ADMIN inside of our role.

Let's try to log in. Go back to the home page. Click logout. Click login. And go admin, admin. And this time we have both roles. Awesome.
